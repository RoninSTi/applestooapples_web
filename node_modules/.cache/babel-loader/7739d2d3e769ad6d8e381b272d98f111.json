{"ast":null,"code":"import _regeneratorRuntime from \"/Users/craigcronin/Development/applestooapples_web_template/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"/Users/craigcronin/Development/applestooapples_web_template/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _slicedToArray from \"/Users/craigcronin/Development/applestooapples_web_template/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";\nimport _objectSpread from \"/Users/craigcronin/Development/applestooapples_web_template/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";\n\nvar _this = this,\n    _jsxFileName = \"/Users/craigcronin/Development/applestooapples_web_template/src/contexts/JWTAuthContext.js\";\n\nimport React, { createContext, useEffect, useReducer } from 'react';\nimport jwtDecode from 'jwt-decode';\nimport SplashScreen from 'src/components/SplashScreen';\nimport axios from 'src/utils/axios';\nvar initialAuthState = {\n  isAuthenticated: false,\n  isInitialised: false,\n  user: null\n};\n\nvar isValidToken = function isValidToken(accessToken) {\n  if (!accessToken) {\n    return false;\n  }\n\n  var decoded = jwtDecode(accessToken);\n  var currentTime = Date.now() / 1000;\n  return decoded.exp > currentTime;\n};\n\nvar setSession = function setSession(accessToken) {\n  if (accessToken) {\n    localStorage.setItem('accessToken', accessToken);\n    axios.defaults.headers.common.Authorization = \"Bearer \".concat(accessToken);\n  } else {\n    localStorage.removeItem('accessToken');\n    delete axios.defaults.headers.common.Authorization;\n  }\n};\n\nvar reducer = function reducer(state, action) {\n  switch (action.type) {\n    case 'INITIALISE':\n      {\n        var _action$payload = action.payload,\n            isAuthenticated = _action$payload.isAuthenticated,\n            user = _action$payload.user;\n        return _objectSpread(_objectSpread({}, state), {}, {\n          isAuthenticated: isAuthenticated,\n          isInitialised: true,\n          user: user\n        });\n      }\n\n    case 'LOGIN':\n      {\n        var _user = action.payload.user;\n        return _objectSpread(_objectSpread({}, state), {}, {\n          isAuthenticated: true,\n          user: _user\n        });\n      }\n\n    case 'LOGOUT':\n      {\n        return _objectSpread(_objectSpread({}, state), {}, {\n          isAuthenticated: false,\n          user: null\n        });\n      }\n\n    case 'REGISTER':\n      {\n        var _user2 = action.payload.user;\n        return _objectSpread(_objectSpread({}, state), {}, {\n          isAuthenticated: true,\n          user: _user2\n        });\n      }\n\n    default:\n      {\n        return _objectSpread({}, state);\n      }\n  }\n};\n\nvar AuthContext = createContext(_objectSpread(_objectSpread({}, initialAuthState), {}, {\n  method: 'JWT',\n  login: function login() {\n    return Promise.resolve();\n  },\n  logout: function logout() {},\n  register: function register() {\n    return Promise.resolve();\n  }\n}));\nexport var AuthProvider = function AuthProvider(_ref) {\n  var children = _ref.children;\n\n  var _useReducer = useReducer(reducer, initialAuthState),\n      _useReducer2 = _slicedToArray(_useReducer, 2),\n      state = _useReducer2[0],\n      dispatch = _useReducer2[1];\n\n  var login = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(email, password) {\n      var response, _response$data, accessToken, user;\n\n      return _regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return axios.post('/api/account/login', {\n                email: email,\n                password: password\n              });\n\n            case 2:\n              response = _context.sent;\n              _response$data = response.data, accessToken = _response$data.accessToken, user = _response$data.user;\n              setSession(accessToken);\n              dispatch({\n                type: 'LOGIN',\n                payload: {\n                  user: user\n                }\n              });\n\n            case 6:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function login(_x, _x2) {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var logout = function logout() {\n    setSession(null);\n    dispatch({\n      type: 'LOGOUT'\n    });\n  };\n\n  var register = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2(email, name, password) {\n      var response, _response$data2, accessToken, user;\n\n      return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              _context2.next = 2;\n              return axios.post('/api/account/register', {\n                email: email,\n                name: name,\n                password: password\n              });\n\n            case 2:\n              response = _context2.sent;\n              _response$data2 = response.data, accessToken = _response$data2.accessToken, user = _response$data2.user;\n              window.localStorage.setItem('accessToken', accessToken);\n              dispatch({\n                type: 'REGISTER',\n                payload: {\n                  user: user\n                }\n              });\n\n            case 6:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function register(_x3, _x4, _x5) {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  useEffect(function () {\n    var initialise = /*#__PURE__*/function () {\n      var _ref4 = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3() {\n        var accessToken, response, user;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.prev = 0;\n                accessToken = window.localStorage.getItem('accessToken');\n\n                if (!(accessToken && isValidToken(accessToken))) {\n                  _context3.next = 11;\n                  break;\n                }\n\n                setSession(accessToken);\n                _context3.next = 6;\n                return axios.get('/api/account/me');\n\n              case 6:\n                response = _context3.sent;\n                user = response.data.user;\n                dispatch({\n                  type: 'INITIALISE',\n                  payload: {\n                    isAuthenticated: true,\n                    user: user\n                  }\n                });\n                _context3.next = 12;\n                break;\n\n              case 11:\n                dispatch({\n                  type: 'INITIALISE',\n                  payload: {\n                    isAuthenticated: false,\n                    user: null\n                  }\n                });\n\n              case 12:\n                _context3.next = 18;\n                break;\n\n              case 14:\n                _context3.prev = 14;\n                _context3.t0 = _context3[\"catch\"](0);\n                console.error(_context3.t0);\n                dispatch({\n                  type: 'INITIALISE',\n                  payload: {\n                    isAuthenticated: false,\n                    user: null\n                  }\n                });\n\n              case 18:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, null, [[0, 14]]);\n      }));\n\n      return function initialise() {\n        return _ref4.apply(this, arguments);\n      };\n    }();\n\n    initialise();\n  }, []);\n\n  if (!state.isInitialised) {\n    return /*#__PURE__*/React.createElement(SplashScreen, {\n      __self: _this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 170,\n        columnNumber: 12\n      }\n    });\n  }\n\n  return /*#__PURE__*/React.createElement(AuthContext.Provider, {\n    value: _objectSpread(_objectSpread({}, state), {}, {\n      method: 'JWT',\n      login: login,\n      logout: logout,\n      register: register\n    }),\n    __self: _this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 174,\n      columnNumber: 5\n    }\n  }, children);\n};\nexport default AuthContext;","map":{"version":3,"sources":["/Users/craigcronin/Development/applestooapples_web_template/src/contexts/JWTAuthContext.js"],"names":["React","createContext","useEffect","useReducer","jwtDecode","SplashScreen","axios","initialAuthState","isAuthenticated","isInitialised","user","isValidToken","accessToken","decoded","currentTime","Date","now","exp","setSession","localStorage","setItem","defaults","headers","common","Authorization","removeItem","reducer","state","action","type","payload","AuthContext","method","login","Promise","resolve","logout","register","AuthProvider","children","dispatch","email","password","post","response","data","name","window","initialise","getItem","get","console","error"],"mappings":";;;;;;;;AAAA,OAAOA,KAAP,IACEC,aADF,EAEEC,SAFF,EAGEC,UAHF,QAIO,OAJP;AAKA,OAAOC,SAAP,MAAsB,YAAtB;AACA,OAAOC,YAAP,MAAyB,6BAAzB;AACA,OAAOC,KAAP,MAAkB,iBAAlB;AAEA,IAAMC,gBAAgB,GAAG;AACvBC,EAAAA,eAAe,EAAE,KADM;AAEvBC,EAAAA,aAAa,EAAE,KAFQ;AAGvBC,EAAAA,IAAI,EAAE;AAHiB,CAAzB;;AAMA,IAAMC,YAAY,GAAG,SAAfA,YAAe,CAACC,WAAD,EAAiB;AACpC,MAAI,CAACA,WAAL,EAAkB;AAChB,WAAO,KAAP;AACD;;AAED,MAAMC,OAAO,GAAGT,SAAS,CAACQ,WAAD,CAAzB;AACA,MAAME,WAAW,GAAGC,IAAI,CAACC,GAAL,KAAa,IAAjC;AAEA,SAAOH,OAAO,CAACI,GAAR,GAAcH,WAArB;AACD,CATD;;AAWA,IAAMI,UAAU,GAAG,SAAbA,UAAa,CAACN,WAAD,EAAiB;AAClC,MAAIA,WAAJ,EAAiB;AACfO,IAAAA,YAAY,CAACC,OAAb,CAAqB,aAArB,EAAoCR,WAApC;AACAN,IAAAA,KAAK,CAACe,QAAN,CAAeC,OAAf,CAAuBC,MAAvB,CAA8BC,aAA9B,oBAAwDZ,WAAxD;AACD,GAHD,MAGO;AACLO,IAAAA,YAAY,CAACM,UAAb,CAAwB,aAAxB;AACA,WAAOnB,KAAK,CAACe,QAAN,CAAeC,OAAf,CAAuBC,MAAvB,CAA8BC,aAArC;AACD;AACF,CARD;;AAUA,IAAME,OAAO,GAAG,SAAVA,OAAU,CAACC,KAAD,EAAQC,MAAR,EAAmB;AACjC,UAAQA,MAAM,CAACC,IAAf;AACE,SAAK,YAAL;AAAmB;AAAA,8BACiBD,MAAM,CAACE,OADxB;AAAA,YACTtB,eADS,mBACTA,eADS;AAAA,YACQE,IADR,mBACQA,IADR;AAGjB,+CACKiB,KADL;AAEEnB,UAAAA,eAAe,EAAfA,eAFF;AAGEC,UAAAA,aAAa,EAAE,IAHjB;AAIEC,UAAAA,IAAI,EAAJA;AAJF;AAMD;;AACD,SAAK,OAAL;AAAc;AAAA,YACJA,KADI,GACKkB,MAAM,CAACE,OADZ,CACJpB,IADI;AAGZ,+CACKiB,KADL;AAEEnB,UAAAA,eAAe,EAAE,IAFnB;AAGEE,UAAAA,IAAI,EAAJA;AAHF;AAKD;;AACD,SAAK,QAAL;AAAe;AACb,+CACKiB,KADL;AAEEnB,UAAAA,eAAe,EAAE,KAFnB;AAGEE,UAAAA,IAAI,EAAE;AAHR;AAKD;;AACD,SAAK,UAAL;AAAiB;AAAA,YACPA,MADO,GACEkB,MAAM,CAACE,OADT,CACPpB,IADO;AAGf,+CACKiB,KADL;AAEEnB,UAAAA,eAAe,EAAE,IAFnB;AAGEE,UAAAA,IAAI,EAAJA;AAHF;AAKD;;AACD;AAAS;AACP,iCAAYiB,KAAZ;AACD;AAtCH;AAwCD,CAzCD;;AA2CA,IAAMI,WAAW,GAAG9B,aAAa,iCAC5BM,gBAD4B;AAE/ByB,EAAAA,MAAM,EAAE,KAFuB;AAG/BC,EAAAA,KAAK,EAAE;AAAA,WAAMC,OAAO,CAACC,OAAR,EAAN;AAAA,GAHwB;AAI/BC,EAAAA,MAAM,EAAE,kBAAM,CAAG,CAJc;AAK/BC,EAAAA,QAAQ,EAAE;AAAA,WAAMH,OAAO,CAACC,OAAR,EAAN;AAAA;AALqB,GAAjC;AAQA,OAAO,IAAMG,YAAY,GAAG,SAAfA,YAAe,OAAkB;AAAA,MAAfC,QAAe,QAAfA,QAAe;;AAAA,oBAClBpC,UAAU,CAACuB,OAAD,EAAUnB,gBAAV,CADQ;AAAA;AAAA,MACrCoB,KADqC;AAAA,MAC9Ba,QAD8B;;AAG5C,MAAMP,KAAK;AAAA,yEAAG,iBAAOQ,KAAP,EAAcC,QAAd;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBACWpC,KAAK,CAACqC,IAAN,CAAW,oBAAX,EAAiC;AAAEF,gBAAAA,KAAK,EAALA,KAAF;AAASC,gBAAAA,QAAQ,EAARA;AAAT,eAAjC,CADX;;AAAA;AACNE,cAAAA,QADM;AAAA,+BAEkBA,QAAQ,CAACC,IAF3B,EAEJjC,WAFI,kBAEJA,WAFI,EAESF,IAFT,kBAESA,IAFT;AAIZQ,cAAAA,UAAU,CAACN,WAAD,CAAV;AACA4B,cAAAA,QAAQ,CAAC;AACPX,gBAAAA,IAAI,EAAE,OADC;AAEPC,gBAAAA,OAAO,EAAE;AACPpB,kBAAAA,IAAI,EAAJA;AADO;AAFF,eAAD,CAAR;;AALY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAH;;AAAA,oBAALuB,KAAK;AAAA;AAAA;AAAA,KAAX;;AAaA,MAAMG,MAAM,GAAG,SAATA,MAAS,GAAM;AACnBlB,IAAAA,UAAU,CAAC,IAAD,CAAV;AACAsB,IAAAA,QAAQ,CAAC;AAAEX,MAAAA,IAAI,EAAE;AAAR,KAAD,CAAR;AACD,GAHD;;AAKA,MAAMQ,QAAQ;AAAA,yEAAG,kBAAOI,KAAP,EAAcK,IAAd,EAAoBJ,QAApB;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBACQpC,KAAK,CAACqC,IAAN,CAAW,uBAAX,EAAoC;AACzDF,gBAAAA,KAAK,EAALA,KADyD;AAEzDK,gBAAAA,IAAI,EAAJA,IAFyD;AAGzDJ,gBAAAA,QAAQ,EAARA;AAHyD,eAApC,CADR;;AAAA;AACTE,cAAAA,QADS;AAAA,gCAMeA,QAAQ,CAACC,IANxB,EAMPjC,WANO,mBAMPA,WANO,EAMMF,IANN,mBAMMA,IANN;AAQfqC,cAAAA,MAAM,CAAC5B,YAAP,CAAoBC,OAApB,CAA4B,aAA5B,EAA2CR,WAA3C;AAEA4B,cAAAA,QAAQ,CAAC;AACPX,gBAAAA,IAAI,EAAE,UADC;AAEPC,gBAAAA,OAAO,EAAE;AACPpB,kBAAAA,IAAI,EAAJA;AADO;AAFF,eAAD,CAAR;;AAVe;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KAAH;;AAAA,oBAAR2B,QAAQ;AAAA;AAAA;AAAA,KAAd;;AAkBAnC,EAAAA,SAAS,CAAC,YAAM;AACd,QAAM8C,UAAU;AAAA,2EAAG;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAETpC,gBAAAA,WAFS,GAEKmC,MAAM,CAAC5B,YAAP,CAAoB8B,OAApB,CAA4B,aAA5B,CAFL;;AAAA,sBAIXrC,WAAW,IAAID,YAAY,CAACC,WAAD,CAJhB;AAAA;AAAA;AAAA;;AAKbM,gBAAAA,UAAU,CAACN,WAAD,CAAV;AALa;AAAA,uBAOUN,KAAK,CAAC4C,GAAN,CAAU,iBAAV,CAPV;;AAAA;AAOPN,gBAAAA,QAPO;AAQLlC,gBAAAA,IARK,GAQIkC,QAAQ,CAACC,IARb,CAQLnC,IARK;AAUb8B,gBAAAA,QAAQ,CAAC;AACPX,kBAAAA,IAAI,EAAE,YADC;AAEPC,kBAAAA,OAAO,EAAE;AACPtB,oBAAAA,eAAe,EAAE,IADV;AAEPE,oBAAAA,IAAI,EAAJA;AAFO;AAFF,iBAAD,CAAR;AAVa;AAAA;;AAAA;AAkBb8B,gBAAAA,QAAQ,CAAC;AACPX,kBAAAA,IAAI,EAAE,YADC;AAEPC,kBAAAA,OAAO,EAAE;AACPtB,oBAAAA,eAAe,EAAE,KADV;AAEPE,oBAAAA,IAAI,EAAE;AAFC;AAFF,iBAAD,CAAR;;AAlBa;AAAA;AAAA;;AAAA;AAAA;AAAA;AA2BfyC,gBAAAA,OAAO,CAACC,KAAR;AACAZ,gBAAAA,QAAQ,CAAC;AACPX,kBAAAA,IAAI,EAAE,YADC;AAEPC,kBAAAA,OAAO,EAAE;AACPtB,oBAAAA,eAAe,EAAE,KADV;AAEPE,oBAAAA,IAAI,EAAE;AAFC;AAFF,iBAAD,CAAR;;AA5Be;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,OAAH;;AAAA,sBAAVsC,UAAU;AAAA;AAAA;AAAA,OAAhB;;AAsCAA,IAAAA,UAAU;AACX,GAxCQ,EAwCN,EAxCM,CAAT;;AA0CA,MAAI,CAACrB,KAAK,CAAClB,aAAX,EAA0B;AACxB,wBAAO,oBAAC,YAAD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAAP;AACD;;AAED,sBACE,oBAAC,WAAD,CAAa,QAAb;AACE,IAAA,KAAK,kCACAkB,KADA;AAEHK,MAAAA,MAAM,EAAE,KAFL;AAGHC,MAAAA,KAAK,EAALA,KAHG;AAIHG,MAAAA,MAAM,EAANA,MAJG;AAKHC,MAAAA,QAAQ,EAARA;AALG,MADP;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,KASGE,QATH,CADF;AAaD,CAlGM;AAoGP,eAAeR,WAAf","sourcesContent":["import React, {\n  createContext,\n  useEffect,\n  useReducer\n} from 'react';\nimport jwtDecode from 'jwt-decode';\nimport SplashScreen from 'src/components/SplashScreen';\nimport axios from 'src/utils/axios';\n\nconst initialAuthState = {\n  isAuthenticated: false,\n  isInitialised: false,\n  user: null\n};\n\nconst isValidToken = (accessToken) => {\n  if (!accessToken) {\n    return false;\n  }\n\n  const decoded = jwtDecode(accessToken);\n  const currentTime = Date.now() / 1000;\n\n  return decoded.exp > currentTime;\n};\n\nconst setSession = (accessToken) => {\n  if (accessToken) {\n    localStorage.setItem('accessToken', accessToken);\n    axios.defaults.headers.common.Authorization = `Bearer ${accessToken}`;\n  } else {\n    localStorage.removeItem('accessToken');\n    delete axios.defaults.headers.common.Authorization;\n  }\n};\n\nconst reducer = (state, action) => {\n  switch (action.type) {\n    case 'INITIALISE': {\n      const { isAuthenticated, user } = action.payload;\n\n      return {\n        ...state,\n        isAuthenticated,\n        isInitialised: true,\n        user\n      };\n    }\n    case 'LOGIN': {\n      const { user } = action.payload;\n\n      return {\n        ...state,\n        isAuthenticated: true,\n        user\n      };\n    }\n    case 'LOGOUT': {\n      return {\n        ...state,\n        isAuthenticated: false,\n        user: null\n      };\n    }\n    case 'REGISTER': {\n      const { user } = action.payload;\n\n      return {\n        ...state,\n        isAuthenticated: true,\n        user\n      };\n    }\n    default: {\n      return { ...state };\n    }\n  }\n};\n\nconst AuthContext = createContext({\n  ...initialAuthState,\n  method: 'JWT',\n  login: () => Promise.resolve(),\n  logout: () => { },\n  register: () => Promise.resolve()\n});\n\nexport const AuthProvider = ({ children }) => {\n  const [state, dispatch] = useReducer(reducer, initialAuthState);\n\n  const login = async (email, password) => {\n    const response = await axios.post('/api/account/login', { email, password });\n    const { accessToken, user } = response.data;\n\n    setSession(accessToken);\n    dispatch({\n      type: 'LOGIN',\n      payload: {\n        user\n      }\n    });\n  };\n\n  const logout = () => {\n    setSession(null);\n    dispatch({ type: 'LOGOUT' });\n  };\n\n  const register = async (email, name, password) => {\n    const response = await axios.post('/api/account/register', {\n      email,\n      name,\n      password\n    });\n    const { accessToken, user } = response.data;\n\n    window.localStorage.setItem('accessToken', accessToken);\n\n    dispatch({\n      type: 'REGISTER',\n      payload: {\n        user\n      }\n    });\n  };\n\n  useEffect(() => {\n    const initialise = async () => {\n      try {\n        const accessToken = window.localStorage.getItem('accessToken');\n\n        if (accessToken && isValidToken(accessToken)) {\n          setSession(accessToken);\n\n          const response = await axios.get('/api/account/me');\n          const { user } = response.data;\n\n          dispatch({\n            type: 'INITIALISE',\n            payload: {\n              isAuthenticated: true,\n              user\n            }\n          });\n        } else {\n          dispatch({\n            type: 'INITIALISE',\n            payload: {\n              isAuthenticated: false,\n              user: null\n            }\n          });\n        }\n      } catch (err) {\n        console.error(err);\n        dispatch({\n          type: 'INITIALISE',\n          payload: {\n            isAuthenticated: false,\n            user: null\n          }\n        });\n      }\n    };\n\n    initialise();\n  }, []);\n\n  if (!state.isInitialised) {\n    return <SplashScreen />;\n  }\n\n  return (\n    <AuthContext.Provider\n      value={{\n        ...state,\n        method: 'JWT',\n        login,\n        logout,\n        register\n      }}\n    >\n      {children}\n    </AuthContext.Provider>\n  );\n};\n\nexport default AuthContext;"]},"metadata":{},"sourceType":"module"}